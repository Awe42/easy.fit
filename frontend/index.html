<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>easy.fit PWA Demo</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --brand-gradient: linear-gradient(135deg, #ff9a76 0%, #6dd5ed 100%);
            --brand-orange: #ff9a76;
            --brand-blue: #6dd5ed;
            --bg-light: #f4f7f6;
            --text-dark: #2d3436;
            --card-bg: #ffffff;
            --grey-text: #b2bec3;
            --alert-red: #e15f41;
            --good-green: #2ecc71;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0; padding: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Utility Class for Tab Switching */
        .hidden { display: none !important; }

        .app-header {
            background: white; color: var(--text-dark); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10;
        }
        .logo-container { display: flex; align-items: center; }
        .brand-text {
            font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; background: var(--brand-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; margin-left: 8px;
        }
        .profile-icon { font-size: 1.4rem; color: var(--grey-text); }

        .container { padding: 20px; max-width: 480px; margin: 0 auto; }

        /* --- AGENT BANNER --- */
        .agent-banner {
            background: white; border-radius: 16px; padding: 20px; box-shadow: 0 8px 20px rgba(109, 213, 237, 0.15); margin-bottom: 25px; border-left: 6px solid var(--brand-blue); position: relative; overflow: hidden; transition: all 0.3s ease;
            display: none; opacity: 0; transform: translateY(-20px);
        }
        .agent-banner.show { display: block; opacity: 1; transform: translateY(0); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .banner-header { display: flex; align-items: center; margin-bottom: 12px; color: var(--brand-blue); font-weight: 700; font-size: 1.1rem; }
        .agent-icon { margin-right: 8px; font-size: 1.2rem; }
        .banner-body { font-size: 1rem; line-height: 1.5; }

        /* --- GREETING SECTION --- */
        .greeting-section { margin-bottom: 25px; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1.greeting-title { margin: 0; font-weight: 800; font-size: 2rem; color: var(--text-dark); letter-spacing: -0.5px;}
        .greeting-subtitle { color: var(--grey-text); font-size: 0.9rem; margin-top: 8px; font-weight: 500; }

        /* --- SECTION HEADERS --- */
        h3.section-title { margin-bottom: 15px; color: var(--text-dark); font-weight: 800; font-size: 1.2rem; margin-top: 30px;}
        .subtitle-text { color: var(--grey-text); font-size: 0.95rem; margin-bottom: 20px; line-height: 1.4; }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: center; }
        .stat-header { display: flex; align-items: center; color: var(--grey-text); font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; }
        .stat-icon { margin-right: 8px; font-size: 1.1rem; }
        .stat-value { font-size: 1.8rem; font-weight: 800; line-height: 1.2; }
        .stat-subtext { font-size: 0.85rem; color: var(--grey-text); margin-top: 5px; font-weight: 500;}
        .stat-card.alert .stat-value, .stat-card.alert .stat-icon { color: var(--alert-red); }
        .stat-card.good .stat-value, .stat-card.good .stat-icon { color: var(--good-green); }

        /* --- PRIORITIES / ACTIVITIES LIST --- */
        .priority-list { display: flex; flex-direction: column; gap: 12px; min-height: 120px; }
        .priority-item { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.04); animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Agent Event Style */
        .priority-item.agent-event { border-left: 4px solid var(--brand-blue); background: linear-gradient(to right, #f4fbff, white); }
        
        /* User Event Style (UPDATED: Looks active now) */
        .priority-item.user-event { border-left: 4px solid var(--brand-orange); background: #fffafa; }
        
        /* Cancelled/Rejected style (for Activities tab) */
        .priority-item.cancelled { border-left: 4px solid var(--grey-text); opacity: 0.7; background: #fafafa; }
        .priority-item.cancelled .event-title { text-decoration: line-through; color: var(--grey-text); }
        .priority-item.cancelled .agent-badge { color: var(--alert-red); }


        .event-content { flex: 1; }
        .agent-badge { font-size: 0.7rem; color: var(--brand-blue); font-weight: 600; display: flex; align-items: center; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .event-title { font-weight: 700; margin-bottom: 4px; font-size: 1rem; }
        .event-details { font-size: 0.85rem; color: #7f8c8d; display: flex; align-items: center; gap: 5px; margin-bottom: 2px;}
        .event-icon { font-size: 1.8rem; margin-left: 15px; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white;
            padding: 10px 20px 20px 20px;
            display: flex; justify-content: space-around;
            border-top: 1px solid #eee; color: var(--grey-text); z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }
        .nav-item {
            text-align: center; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px;
            cursor: pointer; transition: all 0.2s ease;
            padding: 8px 16px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-icon {
            width: 24px; height: 24px; margin-bottom: 4px; display: block;
            fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        .nav-item.active { color: var(--brand-blue); background-color: #f0f7ff; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-container">
            <img src="logo.png" alt="easy.fit Logo" style="width:120px; height:40px;">
        </div>
        <div class="profile-icon">üë§</div>
    </header>

    <main class="container">

        <div id="home-view">
            <div id="agent-banner" class="agent-banner">
                <div class="banner-header"><span class="agent-icon">‚ö°</span> The Orchestrator Acted</div>
                <div id="banner-body" class="banner-body"></div>
            </div>
            
            <div id="greeting-section" class="greeting-section">
                 <h1 class="greeting-title">Hi, there!</h1>
                 <div class="greeting-subtitle">Loading profile...</div>
            </div>

            <h3 class="section-title">Health & Wellness Overview</h3>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card"><div class="stat-value">--</div><div class="stat-subtext">Loading...</div></div>
                <div class="stat-card"><div class="stat-value">--</div><div class="stat-subtext">Loading...</div></div>
                <div class="stat-card"><div class="stat-value">--</div><div class="stat-subtext">Loading...</div></div>
                <div class="stat-card"><div class="stat-value">--</div><div class="stat-subtext">Loading...</div></div>
            </div>

            <h3 class="section-title">Today's Priorities</h3>
            <div id="priority-list" class="priority-list">
                <div class="priority-item user-event" style="opacity: 0.4;">
                     <div class="event-content"><div class="event-title">Loading calendar...</div></div>
                </div>
            </div>
        </div> <div id="activities-view" class="hidden">
             <h3 class="section-title" style="margin-top: 0;">Scout Opportunities</h3>
             <div class="subtitle-text">
                The Scout found these nearby activities, but the Orchestrator rejected them based on your current bio-data (e.g., high stress).
             </div>

             <div id="rejected-list" class="priority-list">
                 <div style="padding: 20px; text-align: center; color: #999;">Scanning for rejected items...</div>
             </div>
        </div> </main>

    <nav class="bottom-nav">
        <div id="nav-home" class="nav-item active" onclick="switchTab('home')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Home
        </div>
        <div id="nav-activities" class="nav-item" onclick="switchTab('activities')">
             <svg class="nav-icon" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
            </svg>
            Activities
        </div>
        <div id="nav-chat" class="nav-item" onclick="switchTab('chat')">
             <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Chat
        </div>
    </nav>


<script>
    let currentAgentOutput = null;

    function switchTab(tabName) {
        const homeView = document.getElementById('home-view');
        const activitiesView = document.getElementById('activities-view');
        const navHome = document.getElementById('nav-home');
        const navActivities = document.getElementById('nav-activities');
        const navChat = document.getElementById('nav-chat');

        homeView.classList.add('hidden');
        activitiesView.classList.add('hidden');
        navHome.classList.remove('active');
        navActivities.classList.remove('active');
        navChat.classList.remove('active');

        if (tabName === 'home') {
            homeView.classList.remove('hidden');
            navHome.classList.add('active');
        } else if (tabName === 'activities') {
            activitiesView.classList.remove('hidden');
            navActivities.classList.add('active');
            if (currentAgentOutput) renderRejectedActivities(currentAgentOutput);
        } else if (tabName === 'chat') {
            navChat.classList.add('active');
        }
    }

    async function initializeApp() {
        const banner = document.getElementById('agent-banner');
        const bannerBody = document.getElementById('banner-body');
        const priorityList = document.getElementById('priority-list');
        const greetingSection = document.getElementById('greeting-section');

        try {
            // 1. FETCH CONTEXT
            const contextResponse = await fetch('./sample_input.json');
            if (!contextResponse.ok) throw new Error("Failed to load sample_input.json");
            const alexContextData = await contextResponse.json();

            // 2. RENDER PERSONALIZED UI IMMEDIATELY
            renderGreeting(alexContextData);
            renderStats(alexContextData);
            renderInitialCalendar(alexContextData);
            
            // 3. CALL API (ASYNC)
            const apiResponse = await fetch('http://localhost:3000/api/chat', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contextData: alexContextData }) 
            });
            if (!apiResponse.ok) throw new Error(`HTTP Error: ${apiResponse.status}`);
            const data = await apiResponse.json();
            if (!data.success || !data.reply) throw new Error("Invalid API response");

            // 4. PROCESS AGENT OUTPUT
            const jsonRegex = /```json([\s\S]*?)```/;
            const match = data.reply.match(jsonRegex);
            const cleanedJsonString = (match && match[1]) ? match[1].trim() : data.reply;
            
            try { 
                currentAgentOutput = JSON.parse(cleanedJsonString);
            } catch (e) { throw new Error("Agent output contained invalid JSON."); }


            // 5. UPDATE HOME VIEW UI
            // A. Update Banner (Show if there's an IMMEDIATE action)
            const immediateAction = currentAgentOutput.scheduled_activities.find(act => act.time === 'IMMEDIATE');
            
            if (immediateAction) {
                let bannerText = "";
                if (immediateAction.action === 'ENVIRONMENT_ADJUSTMENT') {
                    bannerText = `<strong>Critical Stress detected.</strong> I have executed a <em>${immediateAction.activity}</em>.<br><br>Lowered screen brightness and enabled "Do Not Disturb" to help break the stress loop.`;
                } else if (immediateAction.action === 'LOCATION_VISIT') {
                    bannerText = `<strong>Action Required.</strong> Based on your current state, I have scheduled an immediate <em>${immediateAction.activity}</em>.<br><br>This will help provide a necessary environmental reset.`;
                } else {
                     bannerText = `<strong>Action Taken.</strong> I have proactively executed an <em>${immediateAction.activity}</em> to support your wellness goals based on real-time data.`;
                }
                bannerBody.innerHTML = bannerText;
                banner.classList.add('show');
            } else {
                banner.classList.remove('show');
            }

            // B. Update Priority List
            priorityList.innerHTML = ''; 
            // Add Agent's new activities
            currentAgentOutput.scheduled_activities.forEach(act => {
                if(act.action === 'LOCATION_VISIT') {
                    const timeStr = formatTime(act.time, act.date);
                    priorityList.innerHTML += `
                        <div class="priority-item agent-event">
                            <div class="event-content">
                                <div class="agent-badge">ü§ñ Added by Orchestrator</div>
                                <div class="event-title">${act.activity}</div>
                                <div class="event-details">üìç English Garden (with Classmate)</div>
                                <div class="event-details">üïí Recommended: ${timeStr}</div>
                            </div>
                            <div class="event-icon">üå≥</div>
                        </div>
                    `;
                }
            });
            // Add back the user's original event (UPDATED: No longer crossed out)
            if (alexContextData.sentry.gcal.items.length > 0) {
                 const userEvent = alexContextData.sentry.gcal.items[0];
                 const startTime = new Date(userEvent.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 const endTime = new Date(userEvent.end.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 priorityList.innerHTML += `
                    <div class="priority-item user-event">
                        <div class="event-content">
                            <div class="event-title">${userEvent.summary}</div>
                            <div class="event-details">üìÖ ${startTime} - ${endTime}</div>
                        </div>
                        <div class="event-icon">üìÖ</div>
                    </div>
                `;
            }

        } catch (error) {
            console.error(error);
            greetingSection.innerHTML = `<h1 class="greeting-title" style="color: var(--alert-red)">Error Loading</h1><div class="greeting-subtitle">${error.message}</div>`;
        }
    }

    // --- HELPER FUNCTIONS ---
    function renderRejectedActivities(agentOutput) {
        const rejectedList = document.getElementById('rejected-list');
        rejectedList.innerHTML = '';
        const activityWithReason = agentOutput.scheduled_activities.find(act => act.selection_reason);
        if (!activityWithReason || !activityWithReason.selection_reason) {
            rejectedList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No opportunities found or rejected.</div>';
            return;
        }
        const reasoning = activityWithReason.selection_reason;
        const sentences = reasoning.split('. ');
        let foundRejected = false;
        sentences.forEach(sentence => {
            if (sentence.startsWith('REJECTED')) {
                foundRejected = true;
                let cleanSentence = sentence.substring(9); 
                let parts = cleanSentence.split(' (');
                let actName = parts[0] || "Unknown Activity";
                let actReason = (parts[1] || "").replace(')', '');
                rejectedList.innerHTML += `
                    <div class="priority-item cancelled">
                        <div class="event-content">
                            <div class="agent-badge">‚ùå Rejected by Sentry Directive</div>
                            <div class="event-title">${actName}</div>
                            <div class="event-details">${actReason}</div>
                        </div>
                        <div class="event-icon" style="filter: grayscale(1); opacity: 0.5;">üèÉ</div>
                    </div>
                `;
            }
        });
        if (!foundRejected) {
             rejectedList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">All Scout opportunities were accepted.</div>';
        }
    }

    function renderGreeting(data) {
        const profile = data.sentry.user_profile;
        document.getElementById('greeting-section').innerHTML = `
            <h1 class="greeting-title">Hi, ${profile.name}!</h1>
            <div class="greeting-subtitle">${profile.role} ‚Ä¢ ${profile.traits.join(' ‚Ä¢ ')}</div>
        `;
    }

    function renderStats(data) {
        const terra = data.sentry.terra.current_daily_snapshot;
        const rescuetime = data.sentry.rescuetime;
        const statsGrid = document.getElementById('stats-grid');
        const statsData = [
            { id: 'card-recovery', icon: 'üîã', title: 'Recovery Score', value: terra.scores.recovery, unit: '%', subtext: terra.scores.recovery < 40 ? 'Poorly rested' : 'Okay', alert: terra.scores.recovery < 40, good: false },
            { id: 'card-stress', icon: 'ü§Ø', title: 'Avg Stress', value: terra.stress_data.analysis, unit: '', subtext: `Analysis: ${terra.stress_data.avg_stress_level} avg`, alert: terra.stress_data.avg_stress_level > 75, good: false },
            { id: 'card-screentime', icon: 'üì±', title: 'Screen Time', value: rescuetime.total_hours, unit: 'h', subtext: 'VS Code & Gaming', alert: rescuetime.total_hours > 10, good: false },
            { id: 'card-movement', icon: 'üë£', title: 'Movement', value: new Intl.NumberFormat().format(terra.distance_data.steps), unit: '', subtext: 'Steps today', alert: terra.distance_data.steps < 4000, good: false }
        ];
        statsGrid.innerHTML = '';
        statsData.forEach(stat => {
            let classList = 'stat-card';
            if (stat.alert) classList += ' alert';
            if (stat.good) classList += ' good';
            statsGrid.innerHTML += `
                <div class="${classList}" id="${stat.id}">
                    <div class="stat-header"><span class="stat-icon">${stat.icon}</span> ${stat.title}</div>
                    <div class="stat-value">${stat.value}${stat.unit}</div>
                    <div class="stat-subtext">${stat.subtext}</div>
                </div>
            `;
        });
    }

    function renderInitialCalendar(data) {
        const priorityList = document.getElementById('priority-list');
        if (data.sentry.gcal.items.length > 0) {
            const event = data.sentry.gcal.items[0];
            const startTime = new Date(event.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
             const endTime = new Date(event.end.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            priorityList.innerHTML = `
                <div class="priority-item user-event" style="opacity: 1; border-left-color: #b2bec3;">
                    <div class="event-content">
                        <div class="event-title" style="text-decoration: none;">${event.summary}</div>
                        <div class="event-details">üìÖ ${startTime} - ${endTime}</div>
                    </div>
                    <div class="event-icon" style="font-size: 1.5rem; opacity: 0.5;">üìÖ</div>
                </div>
            `;
        } else {
             priorityList.innerHTML = '<div style="padding: 15px; color: #999; text-align: center;">No events today.</div>';
        }
    }

    function formatTime(timeStr, dateStr) {
        if (timeStr === "IMMEDIATE") return "NOW";
        if (!timeStr) return "TBD";
        const today = new Date().toISOString().split('T')[0];
        const actualDate = dateStr || today;
        const dateTimeStr = `${actualDate}T${timeStr}:00`;
        const dateObj = new Date(dateTimeStr);
        if (!isNaN(dateObj.getTime())) {
            return dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        return timeStr;
    }

    // TRIGGER ON PAGE LOAD
    window.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>